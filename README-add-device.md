# 添加设备功能说明

## 功能概述

添加设备页面实现了智能设备的自动搜索和配置功能，支持设备WiFi配置和云端绑定。

## 主要功能

### 1. 网络检测
- 自动检测是否连接到设备WiFi热点（192.168.4.*网段）
- 如果未连接，提示用户连接设备WiFi

### 2. 设备搜索
- 使用雷达样式的搜索动画
- 自动请求设备信息API：`http://192.168.4.1/getDeviceMessage`
- 获取设备类型、设备码、WiFi连接状态等信息

### 3. 设备配置
- 设置设备名称
- 配置WiFi账号和密码
- 发送配置到设备：`http://192.168.4.1/setConfig`

### 4. 连接监控
- 实时监控设备WiFi连接状态
- 显示连接进度动画
- 自动重试机制

### 5. 云端绑定
- 设备连接成功后自动添加到用户设备列表
- 调用云函数保存设备信息到数据库

## 文件结构

```
pages/add-device/
├── add-device.vue              # 添加设备主页面
utils/
├── network-helper.js           # 网络检测工具
├── device-api-mock.js          # 设备API模拟工具
uniCloud-aliyun/
├── cloudfunctions/
│   └── add-device/
│       ├── index.js            # 添加设备云函数
│       └── package.json        # 云函数依赖
└── database/
    └── db_init.json            # 数据库初始化脚本
```

## 使用流程

### 用户操作流程

1. **连接设备WiFi**
   - 在手机WiFi设置中连接设备热点
   - 设备热点通常以设备型号命名

2. **打开添加设备页面**
   - 系统自动检测网络连接
   - 显示搜索界面

3. **搜索设备**
   - 点击"开始搜索设备"按钮
   - 等待设备信息获取完成

4. **配置设备**
   - 输入设备名称
   - 输入家庭WiFi账号和密码
   - 点击"下一步"

5. **等待连接**
   - 系统自动配置设备
   - 监控设备WiFi连接状态

6. **完成添加**
   - 设备成功连接后自动添加到设备列表
   - 可以查看"我的设备"

## API接口

### 设备端API

#### 获取设备信息
```
GET http://192.168.4.1/getDeviceMessage

响应格式:
{
  "deviceType": "智能灯",
  "deviceCode": "SL12345678",
  "isWifiConnected": false,
  "wifiName": "",
  "deviceName": "智能灯_001"
}
```

#### 设置设备配置
```
POST http://192.168.4.1/setConfig

请求参数:
{
  "wifiName": "MyWiFi",
  "wifiPassword": "password123",
  "deviceName": "客厅智能灯"
}

响应格式:
{
  "success": true,
  "message": "配置设置成功"
}
```

### 云函数API

#### 添加设备
```
云函数名: add-device

请求参数:
{
  "deviceCode": "SL12345678",
  "deviceType": "智能灯",
  "deviceName": "客厅智能灯"
}

响应格式:
{
  "success": true,
  "message": "设备添加成功",
  "data": {
    "deviceId": "60f1234567890abcdef12345",
    "deviceCode": "SL12345678",
    "deviceName": "客厅智能灯"
  }
}
```

## 开发环境测试

开发环境下会使用模拟API，无需真实硬件设备：

1. 启动项目：`npm run dev`
2. 打开添加设备页面
3. 系统会模拟设备搜索和配置过程
4. 可以测试完整的用户流程

## 注意事项

1. **网络要求**
   - 设备必须支持AP模式（热点模式）
   - 设备IP地址固定为 192.168.4.1

2. **安全考虑**
   - WiFi密码在传输过程中需要加密
   - 设备码应具有唯一性

3. **错误处理**
   - 网络连接失败
   - 设备无响应
   - WiFi连接超时
   - 云端服务异常

4. **兼容性**
   - 支持iOS和Android平台
   - 需要WiFi权限
   - 建议在真机上测试

## 部署说明

1. **上传云函数**
   ```bash
   # 在HBuilderX中右键云函数目录
   # 选择"上传并运行"
   ```

2. **初始化数据库**
   ```bash
   # 在uniCloud控制台中导入db_init.json
   # 创建相应的数据表和索引
   ```

3. **配置权限**
   ```bash
   # 确保云函数有读写数据库的权限
   # 配置用户登录验证
   ```

## 故障排除

### 常见问题

1. **网络检测失败**
   - 检查设备是否开启WiFi热点
   - 确认手机已连接到设备WiFi

2. **设备搜索失败**
   - 检查设备IP是否为192.168.4.1
   - 确认设备API服务是否正常

3. **WiFi配置失败**
   - 检查WiFi密码是否正确
   - 确认WiFi信号强度

4. **云端添加失败**
   - 检查用户登录状态
   - 确认云函数部署正常

### 调试方法

1. **开启调试模式**
   ```javascript
   // 在页面中添加调试信息
   console.log('当前步骤:', this.currentStep);
   console.log('设备信息:', this.deviceInfo);
   ```

2. **查看网络请求**
   ```javascript
   // 在浏览器开发者工具中查看网络请求
   // 检查API响应状态和数据
   ```

3. **云函数日志**
   ```bash
   # 在uniCloud控制台查看云函数执行日志
   # 检查错误信息和执行时间